VERSION 5.00
Begin VB.Form frmSplash 
   BorderStyle     =   1  'Fixed Single
   ClientHeight    =   2055
   ClientLeft      =   30
   ClientTop       =   330
   ClientWidth     =   5625
   Icon            =   "frmSlpash.frx":0000
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   Moveable        =   0   'False
   NegotiateMenus  =   0   'False
   ScaleHeight     =   2055
   ScaleWidth      =   5625
   StartUpPosition =   2  'CenterScreen
   Begin VB.CommandButton Command1 
      Caption         =   "&Cancel"
      Default         =   -1  'True
      Height          =   345
      Left            =   4320
      TabIndex        =   1
      Top             =   1515
      Width           =   1125
   End
   Begin VB.Timer Timer1 
      Enabled         =   0   'False
      Interval        =   200
      Left            =   4740
      Top             =   705
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   26
      Left            =   4065
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   25
      Left            =   3930
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   24
      Left            =   3780
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   23
      Left            =   3630
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   22
      Left            =   3480
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   21
      Left            =   3330
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   20
      Left            =   3180
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   19
      Left            =   3030
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   18
      Left            =   2880
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   17
      Left            =   2730
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   16
      Left            =   2580
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   15
      Left            =   2430
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   14
      Left            =   2280
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   13
      Left            =   2130
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   12
      Left            =   1980
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   11
      Left            =   1845
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   10
      Left            =   1695
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   9
      Left            =   1560
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   8
      Left            =   1425
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   7
      Left            =   1275
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   6
      Left            =   1140
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   5
      Left            =   1005
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   4
      Left            =   870
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   3
      Left            =   735
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   2
      Left            =   600
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   1
      Left            =   465
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape2 
      BorderStyle     =   0  'Transparent
      FillColor       =   &H8000000F&
      FillStyle       =   0  'Solid
      Height          =   150
      Index           =   0
      Left            =   330
      Top             =   1560
      Width           =   45
   End
   Begin VB.Shape Shape1 
      BorderColor     =   &H8000000D&
      FillColor       =   &H8000000D&
      FillStyle       =   0  'Solid
      Height          =   135
      Left            =   225
      Top             =   1560
      Width           =   15
   End
   Begin VB.Line Line4 
      BorderColor     =   &H80000014&
      X1              =   4110
      X2              =   4110
      Y1              =   1530
      Y2              =   1710
   End
   Begin VB.Line Line3 
      BorderColor     =   &H80000014&
      X1              =   210
      X2              =   4110
      Y1              =   1695
      Y2              =   1695
   End
   Begin VB.Line Line2 
      BorderColor     =   &H80000010&
      X1              =   195
      X2              =   195
      Y1              =   1530
      Y2              =   1695
   End
   Begin VB.Line Line1 
      BorderColor     =   &H80000010&
      X1              =   195
      X2              =   4125
      Y1              =   1530
      Y2              =   1530
   End
   Begin VB.Image Image1 
      Height          =   660
      Left            =   285
      Picture         =   "frmSlpash.frx":0E42
      Top             =   285
      Width           =   3855
   End
   Begin VB.Label Label1 
      Height          =   255
      Left            =   165
      TabIndex        =   0
      Top             =   1170
      Width           =   4005
   End
End
Attribute VB_Name = "frmSplash"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
'TOP DOWN
Private latency As Single


Private Declare Function GlobalAlloc Lib "kernel32" (ByVal uFlags As Long, ByVal dwBytes As Long) As Long
Private Declare Function GlobalLock Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Function GlobalUnlock Lib "kernel32" (ByVal hMem As Long) As Long
Private Declare Sub MoveMemory Lib "kernel32" Alias "RtlMoveMemory" (pDest As Any, pSource As Any, ByVal dwLength As Long)
Private Declare Function CreateStreamOnHGlobal Lib "ole32" (ByVal hGlobal As Long, ByVal fDeleteOnRelease As Long, ppstm As Any) As Long
Private Declare Function OleLoadPicture Lib "olepro32" (pStream As Any, ByVal lSize As Long, ByVal fRunmode As Long, riid As Any, ppvObj As Any) As Long
Private Declare Function CLSIDFromString Lib "ole32" (ByVal lpsz As Any, pclsid As Any) As Long

Public Function PictureFromByteStream(b() As Byte) As Object
    Dim LowerBound As Long
    Dim ByteCount  As Long
    Dim hMem  As Long
    Dim lpMem  As Long
    Dim IID_IPicture(15)
    Dim istm As Object

    On Error GoTo Err_Init
    If UBound(b, 1) < 0 Then
        Exit Function
    End If
    
    LowerBound = LBound(b)
    ByteCount = (UBound(b) - LowerBound) + 1
    hMem = GlobalAlloc(&H2, ByteCount)
    If hMem <> 0 Then
        lpMem = GlobalLock(hMem)
        If lpMem <> 0 Then
            MoveMemory ByVal lpMem, b(LowerBound), ByteCount
            Call GlobalUnlock(hMem)
            If CreateStreamOnHGlobal(hMem, 1, istm) = 0 Then

                If CLSIDFromString(StrPtr("{7BF80980-BF32-101A-8BBB-00AA00300CAB}"), IID_IPicture(0)) = 0 Then
                  Call OleLoadPicture(ByVal ObjPtr(istm), ByteCount, 0, IID_IPicture(0), PictureFromByteStream)
                End If
            End If
        End If
    End If
    
    Exit Function
    
Err_Init:
    If Err.Number = 9 Then
        'Uninitialized array
        MsgBox "You must pass a non-empty byte array to this function!"
    Else
        MsgBox Err.Number & " - " & Err.Description
    End If
End Function


Private Sub Command1_Click()
    Command1.Enabled = False
    
    If Label1.Caption = "Press F8 for details, or F5 to continue." Then
        End
    Else
        Label1.Caption = "Rollingback changes..."
        frmMain.Command1_Click 1
    End If
End Sub

Private Sub Command1_KeyDown(KeyCode As Integer, Shift As Integer)
    If latency < 20 And latency > -1 Then
        If KeyCode = 119 Then
            Timer1.Enabled = False
            SimSilence = Normal
            frmMain.StartWizard
            Unload Me
        ElseIf KeyCode = 116 Then
            latency = 20
            Timer1.Enabled = True
        End If
    End If
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    If latency < 20 And latency > -1 Then
        If KeyCode = 119 Then
            Timer1.Enabled = False
            SimSilence = Normal
            frmMain.StartWizard
            Unload Me
        ElseIf KeyCode = 116 Then
            latency = 20
            Timer1.Enabled = True
        End If
    End If
End Sub

Private Sub Form_Load()
    Label1.Caption = "Press F8 for details, or F5 to continue."
    Me.Caption = IIf(Program.Installed, "Uninstalling", "Installing") & " " & Program.Display
End Sub


Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If UnloadMode <> 1 Then
        Cancel = -CInt(Not CBool(Forms.Count > 1))
        Unload frmMain
    End If
End Sub

Public Sub StatusText(ByVal txtInfo As String)
    If latency = -1 And Not Label1.Caption = "Rollingback changes..." Then

        Dim newtext As String
        Dim diff As Long
        
        If Me.TextWidth(txtInfo) > Label1.Width Then
            diff = Me.TextWidth(NextArg(txtInfo, ":") & ": ")
            newtext = RemoveArg(txtInfo, ":")
            
            Do While ((Me.TextWidth("...." & newtext) + diff) > Label1.Width) And (Not (newtext = ""))
                newtext = Mid(newtext, 2)
            Loop
            If newtext = "" Then newtext = StrReverse(NextArg(StrReverse(RemoveArg(txtInfo, ":")), "\"))
            newtext = NextArg(txtInfo, ":") & ": " & " ..." & newtext
        Else
            newtext = txtInfo
        End If
        If Label1.Caption <> newtext Then Label1.Caption = newtext
    End If
End Sub


Private Sub Timer1_Timer()
    If latency < 20 And Not latency = -1 Then
        latency = latency + 1
    Else
        If latency > -1 Then
            latency = -1
            Label1.Caption = IIf(Program.Installed, "Uninstalling", "Installing") & " " & Program.Display
            frmMain.StartWizard
            DoEvents
        End If
    End If
    
    Dim percentage As Single
    
    If Program.TotalOfItem > 0 Then
        percentage = (((Program.CurrentItem / 100) / Program.TotalOfItem) * 100)
        percentage = 3840 * percentage
        If Not Shape1.Width = percentage Then
            If percentage > 0 Then
                Shape1.Width = percentage
            Else
                Shape1.Width = 0
            End If
        End If
    ElseIf Program.TotalOfBytes > 0 Then
        percentage = (((Program.ByteProgress / 100) / Program.TotalOfBytes) * 100)
        percentage = 3840 * percentage
        If Not Shape1.Width = percentage Then
            If percentage > 0 Then
                Shape1.Width = percentage
            Else
                Shape1.Width = 0
            End If
        End If
    End If

    Static animation As Long
    If animation = 0 Or animation = 123 Then animation = 104

    Set Image1.Picture = PictureFromByteStream(LoadResData(animation, "ANIMATION")) 'PictureFromByteStream(StrConv(LoadResData(animation, "ANIMATION"), vbUnicode))

    animation = animation + 1
End Sub
